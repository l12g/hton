!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).hton={})}(this,(function(e){"use strict";function t(e,...t){return"function"==typeof e?e.call(null,...t):e}const n=()=>{};function r(e,t){const n=new Function(...["ctx",`with(ctx){return ${t}}`]);return()=>n(e)}function o(e,t){if(u(e)&&(e.$next||(e.$next=e.nextElementSibling),t(e),function(e){return u(e)&&[1,11].includes(e.nodeType)}(e)))if(s(e))!function(e,t){[...e.content.childNodes].forEach((e=>o(e,t)))}(e,t);else if(!f(e,"for")&&!(f(e,"if")||f(e,"elseif")||f(e,"else")))for(const n of e.childNodes)o(n,t)}function c(e,t){const n=Object.keys(t);return new Proxy(t,{has:()=>!0,get:(t,r,o)=>n.includes(r)?t[r]:e[r],set:(t,r,o)=>(n.includes(r)?t[r]=o:e[r]=o,!0)})}function i(e){return u(e)&&"INPUT"===e.tagName}function s(e){return u(e)&&"TEMPLATE"===e.tagName}function u(e){return e&&[1,3,11].includes(e.nodeType)}function l(e){return"_"+e}function f(e,t){return e.hasAttribute(l(t))}function a(e,t){return e.getAttribute(l(t))}function d(e,t){return e.removeAttribute(l(t))}const{setCurrent:m,getCurrent:h,effect:p}=function(){let e=null;return{setCurrent:t=>e=t,getCurrent:()=>e,effect:t=>{const r=e;return e=t,t(),e=r,t.$clear||n}}}();function g(e){return new Text("")}function b(e){[...e.childNodes].forEach(b),e.$clears&&e.$clears.forEach(t),e.remove()}function y(e,{dom:n,ctx:o},c){const i=a(n,e);if(d(n,e),!i)return;if(!c)return;const s=r(o,i);E(n,p((()=>{c(t(s),i)})))}function E(e,t){e.$clears.push(t)}const x=function(...e){return(...t)=>{[...e].reduceRight(((e,n)=>{if(null===e)return null;const r=n.apply(null,e);return null===r?null:void 0===r?[...t]:Array.isArray(r)?r:[r]}),[...t])}}((function(e){for(const t of[...e.dom.attributes])if(/^_/.test(t.name)){const n=t.name.slice(1);y(n,e,(t=>{e.dom.setAttribute(n,t)}))}y("attr",e,(t=>{Object.keys(t).forEach((n=>{const r=t[n];!1===r||null==r?e.dom.removeAttribute(n):e.dom.setAttribute(n,r)}))}))}),(function(e){y("ref",e,(n=>{t(n,e.dom)}))}),(function(e){const{dom:t,ctx:n}=e,r=l("model"),o=t.getAttribute(r);if(t.removeAttribute(r),!o)return;const c=i(s=t)&&"checkbox"===s.getAttribute("type")||function(e){return i(e)&&"radio"===e.getAttribute("type")}(t);var s;const u=c?"click":"input",f=new AbortController;t.addEventListener(u,(e=>{n[o]=c?e.target.checked:e.target.value}),{singal:f.signal}),E(t,(()=>f.abort())),E(t,p((()=>{switch(t.tagName){case"INPUT":case"TEXTAREA":c?t.checked=!!n[o]:t.value=n[o];break;case"SELECT":t.selectedIndex=n[o]}})))}),(function(e){let t;return y("on",e,(n=>{t&&t.abort(),t=new AbortController,Object.keys(n).forEach((r=>{e.dom.addEventListener(r,n[r],{signal:t.signal})}))}))}),(function(e){y("style",e,(t=>{Object.keys(t).forEach((n=>{const r=t[n];!1===r||null==r?e.dom.style.removeProperty(n):e.dom.style.setProperty(n,r)}))}))}),(function(e){y("class",e,(t=>{Object.keys(t).forEach((n=>{t[n]?e.dom.classList.add(n):e.dom.classList.remove(n)}))}))}),(function(e){y("html",e,(t=>{e.dom.innerHTML=t}))}),(function(e){return y("text",e,(t=>{e.dom.innerText=t}))}),(function(e){if(!f(e.dom,"if"))return;const{dom:n,ctx:c}=e,i=a(n,"if");d(n,"if");const u=g();n.before(u);const l=(e,t)=>{const n=s(e)?e.content:new DocumentFragment,o=s(e)?[...e.content.childNodes]:[e];return s(e)||o.forEach((e=>n.appendChild(e))),{ower:n,nodes:o,tick:t?r(c,t):()=>!0}},m=[l(n,i)];let h=n.$next;for(;h;){const e=a(h,"elseif")||f(h,"else");if(!e)break;m.push(l(h,e)),h.remove(),d(h,"else"),d(h,"elseif"),h=h.$next}m.forEach((t=>{t.nodes.forEach((n=>{t.ower.appendChild(n),o(n,(t=>{x({...e,dom:t})}))}))})),E(n,p((()=>{let e=-1;for(let n=0;n<m.length;n++){const r=m[n];-1===e&&t(r.tick)&&(e=n),e===n?u.after(r.ower):r.nodes.forEach((e=>r.ower.appendChild(e)))}})))}),(function(e){const{dom:n,ctx:i}=e,u=a(n,"for");if(!u)return;d(n,"for");const l=g();n.replaceWith(l);const f=document.createElement("template");f.innerHTML=s(n)?n.innerHTML:n.outerHTML;const h=u.split(/\bin\b/).map((e=>e.trim())),y=new Error("for must be like 'k,v in list (for object) or item in list (for array)'");let E="",w="",k="";if(2===h.length){E=h[1];const e=h[0].split(",").map((e=>e.trim()));if(0===e.length)throw y;if(1===e.length)k=e[0];else{if(2!==e.length)throw y;k=e[0],w=e[1]}}else{if(1!==h.length)throw y;E=h[0]}let v=[];const $=r(i,E),A=document.createDocumentFragment();return p((()=>{v.forEach(b);const e=t($);t(m,null);(Array.isArray(e)?e.map(((e,t)=>({$key:t,$value:e}))):Object.keys(e).map((t=>({$key:t,$value:e[t]})))).forEach((e=>{const t=f.cloneNode(!0),n={};k&&(n[k]=e.$value),w&&(n[w]=e.$key),o(t,(e=>{x({dom:e,ctx:c(i,n)})})),A.append(t.content),v=[...A.childNodes]})),l.after(A)})),null}),(function(e){if(!u(n=e.dom)||3!==n.nodeType)return;var n;const{dom:o,ctx:c}=e;if(!o.parentNode)return null;const i=o.textContent,s=i.match(/\{(.*?)\}/g);if(s){const e=s.map((e=>({match:e,tick:r(c,e.slice(1,e.length-1))})));E(o,p((()=>{o.textContent=e.reduce(((e,n,r)=>e.replace(n.match,t(n.tick))),i)})))}return null}),(function(e){if(!u(e.dom))return null;e.$clears||(e.dom.$clears=[])}));e.__version__="0.0.3",e.create=function(e){const n=new Map,r=new Proxy({},{has:()=>!0,get(e,t){if(t===Symbol.unscopables)return null;n.get(t)||n.set(t,new Set);const r=h();if(r){const e=r;n.get(t).add(e),e.$clear=()=>{n.get(t).delete(e)}}return e[t]},set(e,t,r){if(e[t]===r)return!0;if(e[t]=r,n.has(t)){n.get(t).forEach((e=>e()))}return!0}}),c=e(r);c&&Object.assign(r,c);const i=new Set;return{mount:e=>{if(!(e="string"==typeof e?document.querySelector(e):e))throw new Error("el not found");if(i.has(e))return;const n=[];o(e,(e=>{n.push((()=>x({dom:e,ctx:r})))})),n.forEach(t),i.add(e)},destroy:()=>{i.forEach((e=>{o(e,(e=>{(e.$clears||[]).forEach(t),e.$clears=void 0}))})),i.clear(),n.clear()},state:r}},e.effect=p}));
